# Система распознавания еды с OpenRouter API

## Обзор

Система распознавания еды была полностью переработана для использования OpenRouter API с моделью `qwen/qwen2.5-vl-32b-instruct:free`. Это обеспечивает более точное распознавание блюд и их питательной ценности.

## Архитектура

### Основные компоненты

1. **OpenRouterAPIService** - сервис для работы с OpenRouter API
2. **FoodRecognitionService** - основной сервис распознавания
3. **FoodRecognitionViewModel** - ViewModel для управления состоянием
4. **FoodRecognitionResult** - модель результатов распознавания

### Поток данных

```
Изображение → Предобработка → Base64 → OpenRouter API → Парсинг JSON → Результат
```

## API Запрос

### Структура запроса

```json
{
  "model": "qwen/qwen2.5-vl-32b-instruct:free",
  "messages": [
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "Проанализируй это фото блюда. Выведи только: название блюда, примерное количество калорий и БЖУ (белки, жиры, углеводы)."
        },
        {
          "type": "image_url",
          "image_url": {
            "url": "data:image/jpeg;base64,..."
          }
        }
      ]
    }
  ],
  "max_tokens": 150,
  "temperature": 0,
  "response_format": {
    "type": "json_schema",
    "json_schema": {
      "name": "meal_analysis_mobile",
      "schema": {
        "type": "object",
        "properties": {
          "название": {"type": "string"},
          "калории": {"type": "number"},
          "бжу": {
            "type": "object",
            "properties": {
              "белки": {"type": "number"},
              "жиры": {"type": "number"},
              "углеводы": {"type": "number"}
            }
          }
        },
        "required": ["название", "калории", "бжу"]
      }
    }
  }
}
```

### Структура ответа

```json
{
  "название": "Куриная грудка с рисом",
  "калории": 295,
  "бжу": {
    "белки": 33.7,
    "жиры": 3.9,
    "углеводы": 28
  }
}
```

## Обработка ошибок

### Типы ошибок

- `imageTooSmall` - изображение слишком маленькое
- `imageTooLarge` - изображение слишком большое
- `unsupportedFormat` - неподдерживаемый формат
- `processingFailed` - ошибка обработки
- `networkError` - ошибка сети
- `apiError(String)` - ошибка API с сообщением
- `invalidResponse` - неверный ответ сервера
- `imageConversionFailed` - ошибка конвертации изображения

### Обработка в UI

- Показ алертов с описанием ошибки
- Предоставление рекомендаций по исправлению
- Автоматический сброс состояния при ошибке

## Состояния загрузки

### Индикаторы прогресса

1. **0-10%** - Анализ качества изображения
2. **10-20%** - Предобработка изображения
3. **20-30%** - Конвертация в base64
4. **30-100%** - Отправка запроса и получение ответа

### UI элементы

- Прогресс-бар с процентами
- Индикатор загрузки в кнопке
- Блокировка кнопок во время обработки
- Анимированные переходы состояний

## Интеграция с UI

### AddMealView

- Автоматическое обновление полей формы
- Показ результатов в модальном окне
- Возможность повтора распознавания
- Применение результатов к форме

### FoodRecognitionResultView

- Детальное отображение результатов
- Кнопки применения и повтора
- Визуализация уверенности распознавания
- Информация о времени обработки

## Тестирование

### Тестовый класс

```swift
// Запуск теста API
await OpenRouterAPITest.testAPI()
```

### Что тестируется

- Подключение к API
- Отправка запросов
- Парсинг ответов
- Обработка ошибок
- Конвертация изображений

## Безопасность

### API ключ

- Хранится в коде (в продакшене должен быть в безопасном месте)
- Используется Bearer токен для авторизации
- Ограничения на количество запросов

### Обработка изображений

- Сжатие до 80% качества
- Изменение размера до 512x512
- Валидация форматов
- Проверка размера файла

## Производительность

### Оптимизации

- Асинхронная обработка
- Кэширование результатов
- Сжатие изображений
- Таймауты запросов

### Мониторинг

- Время обработки
- Размер изображений
- Успешность запросов
- Ошибки API

## Будущие улучшения

1. **Кэширование** - сохранение результатов для похожих изображений
2. **Офлайн режим** - локальное распознавание при отсутствии сети
3. **Пакетная обработка** - анализ нескольких изображений
4. **Улучшенная точность** - использование других моделей
5. **Анализ порций** - определение размера порции по изображению

## Использование

### Базовое использование

```swift
let recognitionService = FoodRecognitionService()
let result = try await recognitionService.recognizeFood(from: image)
```

### С ViewModel

```swift
@StateObject private var viewModel = FoodRecognitionViewModel()
await viewModel.recognizeFood()
```

### Обработка результатов

```swift
if let result = viewModel.recognitionResult {
    // Применение результатов к форме
    mealName = result.recognizedFoods.first?.name ?? ""
    calories = String(Int(result.totalCalories))
    // ...
}
```
